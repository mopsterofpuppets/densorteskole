<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Den Sorte Skole – Hovedskærm</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script src="firebase_c.js"></script>
<style>
/* simplificeret CSS for oversigt */
body{margin:0;padding:0;font-family:sans-serif;text-align:center;background:url('background.jpg') no-repeat center center fixed;background-size:cover;color:#fff;}
#teams{margin:20px;}
.card{display:inline-block;width:100px;height:60px;margin:5px;background:rgba(0,0,0,0.7);color:#ff3333;line-height:60px;font-weight:bold;cursor:pointer;}
#timer{font-size:80px;margin:20px;}
</style>
</head>
<body>
<h1>Den Sorte Skole</h1>
<div>
<canvas id="qrCode"></canvas>
<p>Scan QR-koden for at tilmelde et hold</p>
</div>

<div id="teams"><h3>Tilmeldte hold:</h3><ul id="teamList"></ul></div>
<button id="startBtn">Start spil</button>

<div id="board"></div>
<div id="timer"></div>

<script>
const points=[100,200,300,400,666];
const categories=["Metallica","Iron Maiden","Slayer","Black Sabbath","Judas Priest"];
const board=document.getElementById('board');
const teamList=document.getElementById('teamList');
const startBtn=document.getElementById('startBtn');
let teams=[];
let gameStarted=false;

// QR-kode genereres med join.html
new QRious({element:document.getElementById('qrCode'),value:window.location.origin+'/densorteskole/join.htm',size:200});

// Lyt til teams fra Firebase
db.ref("teams").on('value',snapshot=>{
  teams=[];
  teamList.innerHTML='';
  snapshot.forEach(child=>{
    const t=child.val();
    teams.push({id:child.key,name:t.name});
    const li=document.createElement('li'); li.textContent=t.name; teamList.appendChild(li);
  });
});

// Start spil
startBtn.addEventListener('click',()=>{
  if(teams.length===0) return alert("Ingen hold tilmeldt!");
  gameStarted=true;
  initBoard();
});

// Lav brættet
function initBoard(){
  board.innerHTML='';
  categories.forEach(cat=>{
    const catDiv=document.createElement('div'); catDiv.textContent=cat; board.appendChild(catDiv);
  });
  points.forEach(p=>{
    categories.forEach(cat=>{
      const c=document.createElement('div');
      c.className='card'; c.textContent=p;
      c.addEventListener('click',()=>{if(gameStarted) buzzPhase(cat,p)});
      board.appendChild(c);
    });
  });
}

// Buzz fase
function buzzPhase(category,point){
  const buzzedRef=db.ref("buzz");
  buzzedRef.set({buzzed:false,team:null}); // nulstil
  alert(`Kort valgt: ${category} - ${point} point. Vent på at et hold buzz'er.`);
  db.ref("buzz").on('value',snap=>{
    const b=snap.val();
    if(b.buzzed && b.team){
      document.getElementById('timer').textContent=b.team;
      startTimer(10);
    }
  });
}

// Timer
let timerInterval;
function startTimer(seconds){
  clearInterval(timerInterval);
  let t=seconds; document.getElementById('timer').textContent=t;
  timerInterval=setInterval(()=>{
    t--; document.getElementById('timer').textContent=t;
    if(t<=0){clearInterval(timerInterval);document.getElementById('timer').textContent='';}
  },1000);
}
</script>
</body>
</html>
